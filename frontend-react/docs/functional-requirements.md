# 機能要件（現在の挙動ベース）

本ドキュメントは、現行実装から読み取れる機能要件を整理したものであり、将来的なリプレイス時のチェックリストとして利用することを想定する。

## 1. フロントエンドアプリケーション

### 1.1 認証・セッション

- FE-F-001: アプリ表示時、未認証状態では認証ボタンのみを表示し、各種パネル（ゴール／日付付きゴール／完了統計／タスク一覧）は非表示とする。
- FE-F-002: 「Todoistでログイン」ボタン押下時、Todoist OAuth 2.0 認可画面にリダイレクトする認可 URL を生成し、CSRF 対策として `state` をローカルストレージおよびセッションストレージに保存する。
- FE-F-003: OAuth リダイレクト後、URL クエリから `code` と `state` を取得し、`state` の形式および保存値と一致することを検証した上で、OAuth プロキシに対してコード交換リクエストを送信する。
- FE-F-004: コード交換が成功した場合、取得したアクセストークンを `localStorage.todoist_token` に保存し、アプリ内状態 `isAuthenticated` を `true` にして各パネルの初期化を行う。
- FE-F-005: 認証エラー、`state` 不整合、HTTP エラーなどが発生した場合、Auth コンポーネント内のエラーステートに文言を保持し、モーダル内にエラーメッセージを表示する。
- FE-F-006: 「ログアウト」操作時にはローカルストレージ上の認証情報（トークン、`oauth_state` 等）を削除し、アプリ内状態を未認証に戻すとともに、各パネルの内部状態（サービスインスタンスや統計データ）を初期化する。

### 1.2 テーマ切り替え

- FE-F-010: テーマトグルは `light` / `dark` の 2 種類を提供し、現在のテーマを `documentElement[data-theme]` に反映する。
- FE-F-011: 初回ロード時、ローカルストレージに保存されたテーマを優先し、未設定時は OS の `prefers-color-scheme` 設定に従う。
- FE-F-012: テーマ変更はローカルストレージに保存され、ページ再読み込み後も継続される。

### 1.3 タスク一覧（フィルタ付きネスト表示パネル）

- FE-F-020: フィルタ付きタスクパネルは、認証済みの Todoist アクセストークンから `TodoistService` を初期化し、Todoist のフィルタクエリ（空文字列を含む）を用いてタスクを取得する。
- FE-F-021: `TodoistService.fetchTodosByFilter` は Todoist REST API の `getTasks` / `getTasksByFilter` をカーソル付きでページングし、該当するタスクをすべて取得してからクライアント側でツリー構造（親タスクの再帰取得）を構築する。
- FE-F-022: タスク一覧には、子タスクに対応する親タスク情報を含めたツリーノードが表示される（親タスクが複数階層ある場合は再帰的に取得）。
- FE-F-023: 設定モーダルでは以下の項目を提供する。
  - Todoist のフィルタクエリ文字列（任意、空文字可）
  - `dep-` で始まるラベルを持つ（または先祖に持つ）タスクの非表示設定
- FE-F-024: フィルタクエリと dep 非表示設定はローカルストレージに保存され、次回アクセス時に自動的に復元される。
- FE-F-025: フィルタ入力は 500ms のデバウンス後に自動適用され、適用時にはタスクリストのリロードが行われる。
- FE-F-026: dep 非表示が有効な場合、`hasDepLabelInAncestors` の判定により祖先に `dep-*` ラベルを持つタスクを一覧から除外する。
- FE-F-027: タスク行には完了操作があり、指定したタスク ID に対して Todoist API の `closeTask` を呼び出し、成功後はローカルの一覧から該当タスクを削除する。

### 1.4 ゴールマイルストーン率パネル

- FE-F-030: ゴールマイルストーンパネルは、`@goal` ラベルを持つタスクを Todoist API から取得し、その中で `non-milestone` ラベルを持つタスクの割合を算出して表示する。
- FE-F-031: 表示項目は「非マイルストーンゴール Todo率（%）」「分子／分母の件数（`non-milestone` 件数 / `@goal` 件数）」で構成される。
- FE-F-032: 取得や計算に失敗した場合、パネルは「読み込み中」「エラー」などの状態を持ち、エラー文言を表示する。

### 1.5 日付付きゴールタスクパネル

- FE-F-040: 日付付きゴールパネルは、フィルタ `@goal & !日付なし` を用いて Todoist からタスクを取得する。
- FE-F-041: 取得したタスクのうち、`due.date` が存在し、かつ「今日以降」のものだけを表示対象とする（過去日付のゴールは一覧に含めない）。
- FE-F-042: 各タスクについて、「日付までの残日数（`daysUntilDate`）」を算出し、残日数が少ない順（昇順）に並べて表示する。
- FE-F-043: 残日数に応じて表示ラベル（`今日` / `あとN日` / `N日前`）および表示色クラス（`overdue` / `today` / `urgent` / `soon` / `normal`）を切り替える。
- FE-F-044: 対象タスクが 1 件もない場合、「日付付きゴールタスクがありません」という空表示メッセージを出す。

### 1.6 作業完了統計パネル

- FE-F-050: 作業完了統計パネルは、Todoist Sync API v1 をプロキシ経由で呼び出す `TodoistSyncService` を用いて、作業タスクの完了履歴を取得する。
- FE-F-051: 対象とする完了済みタスクは、コンテンツから抽出したラベルに基づき、以下の条件に合致するものとする。
  - `@毎日のタスク` ラベルを含むタスクは除外する。
  - それ以外で `@task` ラベルを含むタスク、またはコンテンツ末尾が「のマイルストーンを置く」で終わるマイルストーンタスクを計測対象とする。
- FE-F-052: 完了履歴の取得では、日付範囲を最大 90 日のチャンクに分割し、カーソル付きで完了済みタスクをすべて取得した上で日単位に集計する。
- FE-F-053: フロントエンドは表示対象日数として 90 日（3 か月）分の統計を表示する。
- FE-F-054: 7 日移動平均を先頭日から欠損なく描画するため、内部的には表示対象日数に対して 6 日分先行したデータを取得し、`statsForAverage` として保持する。
- FE-F-055: グラフ表示用には、「過去 90 日分の履歴」と「当日分（別 API で取得）」を結合した日次データ列を使用する。日付ラベルは `month/day` 形式の日本ロケール表示を用いる。
- FE-F-056: 当日の統計は、ローカルタイムでの「今日 0 時〜明日 0 時」の範囲で `@task`・マイルストーン対象の完了数を集計し、日付キーと表示用日付文字列を返す。
- FE-F-057: チャートには「過去 7 日間平均」系列のみを描画し、各日付における 7 日平均値（当日を含む）を折れ線グラフとして表示する。
- FE-F-058: パネル上部には、表示対象期間の完了合計件数および現在残っている `@task` の件数を数値として表示する。
- FE-F-059: 「データを取得しなおす」ボタン押下時には、完了統計と当日統計の再取得を行い、その後に残り `@task` 件数の再計算を行う。

### 1.7 エラーハンドリング・表示

- FE-F-070: 各パネルは「読み込み中」「エラー」「データなし」「正常表示」の状態を持ち、状態に応じてプレースホルダテキストを切り替える。
- FE-F-071: ネットワークエラーや Todoist API の認可エラーが発生した場合でも、他のパネルのレンダリングには影響を与えず、エラーが発生したパネルのみがエラー表示になる。

## 2. OAuth プロキシ（proxy/）

- PX-F-001: `POST /oauth/token` エンドポイントを提供し、受け取った `client_id`, `code`, `redirect_uri` を Todoist OAuth トークンエンドポイントに中継する。
- PX-F-002: レスポンスとして、Todoist から返却された `access_token` および `token_type` を JSON 形式でフロントエンドに返す。
- PX-F-003: CORS 設定により、環境変数 `ALLOWED_ORIGIN` で指定したオリジンからのリクエストのみを許可し、それ以外のオリジンからのブラウザリクエストはブロックする。
- PX-F-004: ローカル開発では `http://localhost:8000` で稼働し、フロントエンドの `VITE_PROXY_URL` から参照される。

## 3. Cron 自動化サービス（cron/）

### 3.1 `@goal` / `@task` / `@non-milestone` 管理

- CR-F-010: Cron サービスは環境変数 `TODOIST_TOKEN` を用いて Todoist API クライアントを初期化し、Deno Deploy の `Deno.cron` により 1 時間ごとに自動実行される。
- CR-F-011: `@goal` ラベルを持ち、`@non-milestone` ラベルを持たず、かつ子タスクとして `@task` または `@goal` を持たないタスクを「葉ゴール」として特定する。
- CR-F-012: 葉ゴールに対して `non-milestone` ラベルを付与する（既存ラベルに追加）。
- CR-F-013: `goal` と `non-milestone` の両方を持つタスクで、子タスクに `@task` または `@goal` を持つものからは `non-milestone` ラベルを削除する。
- CR-F-014: `goal` かつ `non-milestone` ラベルを持つタスクのうち、子にマイルストーン系タスク（「のマイルストーンを置く」等）を持たないものに対して、新たに「${ゴール名}のマイルストーンを置く」という子タスクを作成する。

### 3.2 依存関係ラベル（`dep-*`）管理

- CR-F-020: Cron サービスは `goal` ラベル付きタスクを対象に、親子関係に基づく依存関係ラベル名（`dep-*`）を生成し、存在しないラベルについては新規作成する。
- CR-F-021: 生成するラベル名は `dependency-label-utils.ts` の `generateDepLabelName` のルールに従い、ゴール名および親ゴール名から一意に決定される。
- CR-F-022: 現在の `goal` タスク集合から導出されるべき `dep-*` ラベル名の集合と、実際に存在する `dep-*` ラベルとの比較により、不要となった `dep-*` ラベルを削除する。
- CR-F-023: ラベル作成時は既存ラベルとの重複を避けるため、同名ラベルが存在する場合は新規作成せず、そのラベルを再利用する。

