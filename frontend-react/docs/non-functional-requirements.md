# 非機能要件（現在の挙動ベース）

本ドキュメントは、現行実装から読み取れる非機能要件と前提条件を整理し、将来的なリプレイス時に品質面の差分を確認するための基準とする。

## 1. パフォーマンスとスケーラビリティ

- NF-P-001: フロントエンドは、中規模（おおよそ 500 件程度まで）のタスク数を前提として設計されており、フィルタクエリにマッチするタスクを全件取得してからクライアント側でツリー構造を構築する。
- NF-P-002: 大規模（1000 件を大きく超える）タスク件数に対しては、初回ロードや再フィルタリング時のレスポンス低下が起こり得ることを許容している。（現行コードは仮想スクロールやページング表示を実装していない。）
- NF-P-003: 完了統計取得では、Sync API v1 の仕様に合わせて最大 90 日のウィンドウに分割して履歴を取得し、必要日数分を後ろから順に連結することで API 制約内での全件取得を行う。
- NF-P-004: Cron サービスはタスク取得やラベル操作にキャッシュ（5 分程度）を利用し、同一ラベルのタスク取得やラベル一覧取得を短時間に繰り返す際の API 呼び出し回数を抑制している。
- NF-P-005: 残り `@task` 件数の取得は統計取得と別に Todoist REST API を呼び出しており、統計更新ボタン押下時にこれらの API 呼び出しが連続で行われることを前提としている。

## 2. 信頼性・エラーハンドリング

- NF-R-010: フロントエンドの各パネルは独立したエラーステートとローディングステートを持ち、特定の API 呼び出しが失敗しても他パネルの表示に影響を与えない。
- NF-R-011: 完了統計の生成時にはバリデーションライブラリ（`valibot`）で API レスポンスを検証し、想定外のデータ形式の場合は明示的にエラーを投げて処理を中断する。
- NF-R-012: タスク完了処理では、Todoist API から返されるステータスコードやエラーメッセージをもとに、認証エラー・権限エラー・存在しないタスク・バリデーションエラーなどを区別したエラーメッセージを生成する。
- NF-R-013: Cron サービスは各ステップ（`@non-milestone` 付与／削除、マイルストーン作成、依存ラベル生成・削除）の進捗とエラーをログ出力し、エラー発生時にも全体のプロセスが落ちずにログから原因を把握できることを重視している。
- NF-R-014: OAuth プロキシは HTTP ステータスが成功でない場合、エラーメッセージをそのままフロントエンドに返し、フロントエンド側で詳細なエラー内容をログまたは UI で参照できるようにしている。

## 3. セキュリティ・プライバシー

- NF-S-020: OAuth 認証では `state` パラメータをローカルストレージとセッションストレージに保存し、リダイレクト後に受け取った `state` と照合することで CSRF 攻撃を防止する。
- NF-S-021: アクセストークンはブラウザのローカルストレージに保存され、フロントエンドから Todoist API／プロキシへの呼び出しにのみ使用される。サーバー側にユーザー単位のトークンを永続保存するバックエンドは持たない。
- NF-S-022: トークン有効期限はローカルストレージ上の `todoist_token_expires_at` により管理できる設計となっており、有効期限を過ぎたトークンは無効とみなしてクリアする（ただし、リフレッシュトークン運用は現時点では実装されていない）。
- NF-S-023: OAuth プロキシは環境変数 `ALLOWED_ORIGIN` によって許可オリジンを制限し、クロスサイトからの不正なトークン交換リクエストを防ぐ。
- NF-S-024: Cron サービスで使用する `TODOIST_TOKEN` はサーバー環境変数として保持され、CLI 引数やログには出力しない前提で運用する。
- NF-S-025: 完了統計取得では、タスク内容（`content`）から `@ラベル` を抽出して内部的に利用するが、これ以外の機微情報を別ストレージに保存したり第三者に送信したりしないことを前提とする。

## 4. ユーザビリティ・UX

- NF-U-030: レイアウトは 1 画面に 4 パネル（ゴールマイルストーン率、日付付きゴール、完了統計、タスク一覧）が並ぶ構成であり、PC では左右 2 カラム、モバイルでは上下 1 カラムに自動的に切り替わる。
- NF-U-031: 完了統計グラフは レスポンシブな折れ線グラフであり、画面幅に応じてキャンバスサイズを自動調整する。
- NF-U-032: テーマ切り替えボタンはアイコンとツールチップ（タイトル属性）を持ち、現在がダークテーマかライトテーマかを即座に判別できる。
- NF-U-033: フィルタ設定モーダルはテキスト入力とチェックボックスだけで構成され、Todoist のフィルタ構文に慣れたユーザーが追加のヘルプなしで利用できるシンプルさを保つ。
- NF-U-034: 「読み込み中」「エラー」「データなし」時のメッセージは簡潔な日本語で表示され、状況を短い文で把握できる。

## 5. 時刻・日付の扱い

- NF-T-040: 日付計算には `date-fns` を使用し、ローカルタイムゾーン基準で「今日」「明日」「N日前／あと N 日」を判定している。タイムゾーンごとの日付境界の違いは利用環境に依存する。
- NF-T-041: 完了統計の集計では、完了日時 `completed_at` をローカルタイムに変換し、`yyyy-MM-dd` 単位で集約することで「1 日あたりの完了件数」を算出する。
- NF-T-042: 当日の統計は「当日 0:00 ～ 翌日 0:00」の範囲で完了したタスクを対象とし、履歴取得とは別の API 呼び出しとして扱う。
- NF-T-043: 7 日間移動平均は、表示対象期間より 6 日前からのデータを含めた配列をもとに計算し、可視領域の最初の日から欠損なく平均値が定義されるようになっている。

## 6. 運用・デプロイ前提

- NF-O-050: フロントエンドは静的サイトとしてホスティングされる前提であり、Vite ビルド成果物を任意の静的ホスティングサービス（Vercel など）に配置する構成を想定している。
- NF-O-051: OAuth プロキシは Deno Deploy を主なターゲットとし、GitHub リポジトリとの連携による自動デプロイを前提とする。
- NF-O-052: Cron サービスも Deno Deploy の Cron 機能を利用して 1 時間おきに実行される前提であり、ローカルでは Deno タスク（`deno task start` など）で手動実行することを想定している。
- NF-O-053: ローカル開発時、フロントエンドは `http://localhost:5173`、OAuth プロキシは `http://localhost:8000` で動作し、環境変数（`.env`）により Todoist のクライアント ID などを設定する。
- NF-O-054: ラベル命名規則（`@goal`, `@task`, `@non-milestone`, `dep-*`, `@毎日のタスク`, 「日付なし」など）は運用ルールとして事前に Todoist 側で整備されていることを前提とし、アプリ側はそれらを変更しない。
